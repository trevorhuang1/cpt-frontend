<!-- 
Acknowledgements: This part of the project was made possible with
the help of teacher provided code. Specifically, the code to send 
the fetch requests is based off of code that my teacher provided,
although what happens within the fetch request is my own work.
The styling and showTable function were made with the help of generative AI, specifically ChatGPT.
-->

<head>

  <style>
  /* This styling was created by ChatGPT to make the tables look more aesthetically pleasing */
  /* Styling for the menu */
    #menu {
      list-style-type: none;
      padding: 0;
    }
    #menu li {
      display: inline;
      margin-right: 10px;
      cursor: pointer;
    }
  
    .table-container {
      display: none;
    }
    .table-container.active {
      display: block;
    }
  </style>
  </head>
  <body>
  
  <!-- Lines 36 to 58 where generated by ChatGPT -->
  <!-- Showing all three four columns within the table -->
  <ul id="menu">
    <li onclick="showTable('yourFriends')">Your Friends</li>
    <li onclick="showTable('users')">Users</li>
    <li onclick="showTable('trade')">Trade</li>
    <li onclick="showTable('friendRequests')">Friend Requests</li>
  </ul>
  
  <div id="yourFriends" class="table-container active">
    <!-- Table for friends lists to be generated -->
  </div>
  
  <div id="users" class="table-container">
    <!-- Table for users list to be generated -->
  </div>
  
  <div id="trade" class="table-container">
    <!-- Table for items which you can trade to other users -->
  </div>
  
  <div id="friendRequests" class="table-container">
    <!-- Table for friend request list -->
  </div>
  <!-- Form for sending a item to a friend -->
  <div class="container">
    <form id="username" action="javascript:sendItem">
        <p><label>
            Friend ID:
            <input class="userInput" type="text" name="uid" id="uid" required>
        </label></p>
        <p ><label>
            Item:
            <input class="userInput" type="item" name="item" id="item" required>
        </label></p>
        <p>
            <button id="sendButton">Send</button>
        </p>
    </form>
  </div>
  
  <script>
    // Defining the global variables here
    // These are the lists that will be filled with the data from the fetch request
    var yourFriends = [];
    var friendRequests = [];
    var users = [];
    var trade = [];
    const friendUrl = 'http://127.0.0.1:8028/api/users/send';
    const url = "http://127.0.0.1:8028/api/users/";
    const frUrl = 'http://127.0.0.1:8028/api/users/friendrq';
    // Option for the fetch request which will retrieve data from the database on backend server
    const options = {
        method: 'GET',
        mode: 'cors',
        cache: 'default',
        credentials: 'include',
        headers: {
            'Content-Type': 'application/json',
        },
    };
    // Using the current user's uid to generate the table user's friends items and friend requests. 
    // The current user's uid is stored in local storage upon logging in
    var curr_uid = localStorage.getItem("uid");
    generateTable(curr_uid);

    // Function to generate the rows of the table
    function generateRow(containerId, dataList) {
      var container = document.getElementById(containerId);
      container.innerHTML = '';
      var table = document.createElement('table');
      // Iterating through the list given and adding a new cell for every item in the list
      for (let i = 0; i < dataList.length; i++) {
        // Creating a new row for every item in the list
        var row = table.insertRow();
        var cell = row.insertCell();
        cell.appendChild(document.createTextNode(dataList[i]));
        // If the container is the users container, then there is an option to add the user as a friend
        if (containerId == "users") {
          // Button to add users as friends within the table
          var request = row.insertCell()
          var addFriend = document.createElement("button")
          addFriend.textContent = "Add friend";
          // When pressing the addFriend button it sends a POST request and adds the friendRequest within the database
          addFriend.onclick = function() {
            const user = localStorage.getItem("uid");
            const body = {
              sender: user,
              receiver: dataList[i],
            };
            console.log(body)
            const authOptions = {
              ...options, // This will copy all properties from options
              method: 'POST', // Override the method property
              cache: 'no-cache', // Set the cache property
            };
            fetch(frUrl, authOptions)
            .then(response => {
              // If the response is not ok then log the error message
                if (!response.ok) {
                    const errorMsg = response.status;
                    console.log(errorMsg);
                    return;
                }
            })
            // Catch fetch errors if there are any
            .catch(err => {
                console.error(err);
            });
            }
            request.append(addFriend);
        }
        // If the container is the friend requests container then there is an option to accept the friend request
        if (containerId == "friendRequests") {
          // Adding a new cell for the accept button on every cell where there is a friend request
          var fr = row.insertCell()
          var accept = document.createElement("button")
          accept.textContent = "Accept Friend Request";
          // When the accept friend request button is clicked then the fetch request is sent
          accept.onclick = function() {
            const user = localStorage.getItem("uid");
            const body = {
              action: "accepted",
              sender: dataList[i],
              receiver: user,
            };
            console.log(body)
            const authOptions = {
              ...options, // This will copy all properties from options
              method: 'POST', // Override the method property
              cache: 'no-cache', // Set the cache property
            };
            fetch(frUrl, authOptions)
            .then(response => {
                // If the response is not ok then log the error message
                if (!response.ok) {
                    const errorMsg = response.status;
                    console.log(errorMsg);
                    return;
                }
            })
            // Catch fetch errors if there are any
            .catch(err => {
                console.error(err);
            });
            }
            // Otherwise append to the cell
            fr.append(accept);
        }
      }
      container.appendChild(table);
    }
  
    function sendItem(receiver, ingredient) {
      const body = {
              uid: receiver,
              items: ingredient,
          };
          const authOptions = {
              ...options, 
              method: 'POST', 
              cache: 'no-cache', 
              body: JSON.stringify(body)
          };
      // Check if they are friends yet
      if (yourFriends.includes(receiver) == false) {
        alert(`You have to be friends with ${receiver} before sending them an item!`);
        return;
      }
      // Check if the user has the item they are trying to send
      if (trade.includes(ingredient) == false) {
        alert(`You don't have ${ingredient} to send!`);
        return;
      }
      // Otherwise send the fetch request to send the item
      fetch(friendUrl, authOptions)
      .then(response => {
          if (!response.ok) {
              const errorMsg = 'Login error: ' + response.status;
              console.log(errorMsg);
              return;
          }
          alert("You just sent an item!");
      })
      .catch(err => {
          console.error(err);
      });
    }
    function generateTable(curr_uid) {
      // Check for response errors and display them if there are any
      fetch(url, options)
        .then(response => {
            if (response.status !== 200) {
              // If unauthorized then redirect to 401 error page
                if (response.status === 401 || response.status == 403) {
                    window.location.href = "/cpt-frontend/lmc-login";
                }
            }
            response.json().then(data => {
                for (let i = 0; i < data.length; i++) {
                    var user = data[i];
                    users.push(user.uid);
                    // If the user is the current user, then we can get their friends
                    if (user.uid == curr_uid) {
                      // Changes from json to list
                      // This is the list of all of the current user's friends
                      var parsed = JSON.parse(user.friends)
                      for (var j = 0; j < parsed.length; j++){
                        yourFriends.push(parsed[j]);
                      }
                      // Changes from json to list
                      // This is the current user's items list
                      var parsed2 = JSON.parse(user.items)
                      for (var k = 0; k < parsed2.length; k++){
                        trade.push(parsed2[k]);
                      }
                      // Changes from json to list
                      // This is the current user's friend requests list
                      var parsed3 = JSON.parse(user.friendrq)
                      for (var p = 0; p < parsed3.length; p++){
                        friendRequests.push(parsed3[p]);
                      }
                    } 
                }
                // Filling up the rows with the data
                generateRow('yourFriends', yourFriends);
                generateRow('users', users);
                generateRow('trade', trade);
                generateRow('friendRequests', friendRequests);
            });
        })
  
        .catch(err => {
            console.error(err);
        });
      }
    // I used chatgpt to help with this function
    // This helps with table switching when going from column to column
    function showTable(tableId) {
      // Hide all table containers
      var tables = document.querySelectorAll('.table-container');
      tables.forEach(function(table) {
        table.classList.remove('active');
      });
      // Show the selected table container
      var selectedTable = document.getElementById(tableId);
      selectedTable.classList.add('active');
    }
  
    const sendButton = document.getElementById("sendButton")
    // Button to send the item
    sendButton.addEventListener("click", function() {
      // Getting the receiver and ingredient values from the form
      var receiver = document.getElementById("uid").value
      var ingredient = document.getElementById("item").value
      // Call the sendItem using the receiver and ingredient inputted by the user
      sendItem(receiver, ingredient)
      // Refresh the page after sending the item
      window.location.reload();
    })
  </script>
  
  </body>