<!-- 
Acknowledgements: This part of the project was made possible with
the help of teacher provided code. Specifically, the code to send 
the fetch requests is based off of code that my teacher provided,
although what happens within the fetch request is my own work.

The styling and showTable function were made with the help of generative AI, specifically ChatGPT.
-->

<head>

<style>
  /* This styling was created by ChatGPT to make the tables look more aesthetically pleasing */
  /* Styling for the menu */
  #menu {
    list-style-type: none;
    padding: 0;
  }
  #menu li {
    display: inline;
    margin-right: 10px;
    cursor: pointer;
  }
  /* Styling for the tables */
  .table-container {
    display: none;
  }
  .table-container.active {
    display: block;
  }
</style>
</head>
<body>

<!-- Lines 36 to 58 where generated by ChatGPT -->
<!-- Showing all three four columns within the table -->
<ul id="menu">
  <li onclick="showTable('yourFriends')">Your Friends</li>
  <li onclick="showTable('users')">Users</li>
  <li onclick="showTable('trade')">Trade</li>
  <li onclick="showTable('friendRequests')">Friend Requests</li>
</ul>

<div id="yourFriends" class="table-container active">
  <!-- Table for friends lists to be generated -->
</div>

<div id="users" class="table-container">
  <!-- Table for users list to be generated -->
</div>

<div id="trade" class="table-container">
  <!-- Table for items which you can trade to other users -->
</div>

<div id="friendRequests" class="table-container">
  <!-- Table for friend request list -->
</div>

<!-- Form for sending a item to a friend -->
<div class="container">
  <form id="username" action="javascript:sendItem">
      <p><label>
          Friend ID:
          <input class="userInput" type="text" name="uid" id="uid" required>
      </label></p>
      <p ><label>
          Item:
          <input class="userInput" type="item" name="item" id="item" required>
      </label></p>
      <p>
          <button id="sendButton">Send</button>
      </p>
  </form>
</div>

<script>
  // Defining the global variables here
  // These are the lists that will be filled with the data from the fetch request
  var yourFriends = [];
  var friendRequests = [];
  var users = [];
  var trade = [];
  const friendUrl = 'http://127.0.0.1:8028/api/users/send';
  // Getting the current user's id. This was stored in local storage when the user logged in
  var curr_uid = localStorage.getItem("uid");
  const url = "http://127.0.0.1:8028/api/users/";
  const frUrl = 'http://127.0.0.1:8028/api/users/friendrq';
  // Options for the fetch request
  const options = {
      method: 'GET',
      mode: 'cors',
      cache: 'default',
      credentials: 'include',
      headers: {
          'Content-Type': 'application/json',
      },
  };

    // Function to generate the table which includes all users, friendRequests, and items the current user has
  function generateTable(containerId, dataList) {
    var container = document.getElementById(containerId);
    container.innerHTML = '';
    var table = document.createElement('table');
    // Iterating through the list given and adding a new cell for every item in the list
    for (let i = 0; i < dataList.length; i++) {
      var row = table.insertRow();
      var cell = row.insertCell();
      cell.appendChild(document.createTextNode(dataList[i]));

      // If the container is the users container, then there is an option to add the user as a friend
      if (containerId == "users") {
        var request = row.insertCell()
        var addFriend = document.createElement("button")
        addFriend.textContent = "Add friend";
        // When pressing the addFriend button it sends a POST request and adds the friendRequest within the database
        addFriend.onclick = function() {
          const user = localStorage.getItem("uid");
          const body = {
            sender: user,
            receiver: dataList[i],
          };
          console.log(body)
          const authOptions = {
            ...options, // This will copy all properties from options
            method: 'POST', // Override the method property
            cache: 'no-cache', // Set the cache property
            body: JSON.stringify(body)
          };
          fetch(frUrl, authOptions)
          .then(response => {
              // handle error response from Web API
              if (!response.ok) {
                  const errorMsg = response.status;
                  console.log(errorMsg);
                  return;
              }
          })
          // catch fetch errors (ie ACCESS to server blocked)
          .catch(err => {
              console.error(err);
          });
          }
          request.append(addFriend);
      }
      
      // If the container is the friend requests container then there is an option to accept the friend request
      if (containerId == "friendRequests") {
        var fr = row.insertCell()
        var accept = document.createElement("button")
        accept.textContent = "Accept Friend Request";
        accept.onclick = function() {
          const user = localStorage.getItem("uid");
          const body = {
            action: "accepted",
            sender: dataList[i],
            receiver: user,
          };
          console.log(body)
          const authOptions = {
            ...options, // This will copy all properties from options
            method: 'DELETE', // Override the method property
            cache: 'no-cache', // Set the cache property
            body: JSON.stringify(body)
          };
          fetch(frUrl, authOptions)
          .then(response => {
              // handle error response from Web API
              if (!response.ok) {
                  const errorMsg = response.status;
                  console.log(errorMsg);
                  return;
              }
          })
          // catch fetch errors (ie ACCESS to server blocked)
          .catch(err => {
              console.error(err);
          });
          }
          fr.append(accept);
      }
    }
    container.appendChild(table);
  }

  function sendItem(){
    //body to send the item in the POST request
    const body = {
            uid: document.getElementById("uid").value,
            items: document.getElementById("item").value,
        };
        const authOptions = {
            ...options, // This will copy all properties from options
            method: 'POST', // Override the method property
            cache: 'no-cache', // Set the cache property
            body: JSON.stringify(body)
        };
    fetch(friendUrl, authOptions)
    .then(response => {
        // handle error response from Web API
        if (!response.ok) {
            const errorMsg = 'Login error: ' + response.status;
            console.log(errorMsg);
            return;
        }
        // Send alert for success!
        alert("You just sent an item!");
    })
    // catch fetch errors (ie ACCESS to server blocked)
    .catch(err => {
        console.error(err);
    });
  }

  fetch(url, options)
      .then(response => {
          // Check for response errors and display
          if (response.status !== 200) {
              if (response.status === 401 || response.status == 403) {
                  // If unauthorized then redirect to 401 error page
                  window.location.href = "/cpt-frontend/lmc-login";
              }
          }
          response.json().then(data => {
              for (let i = 0; i < data.length; i++) {
                  var user = data[i];
                  users.push(user.uid);
                  // If the user is the current user, then we can get their friends
                  if (user.uid == curr_uid) {
                    // Changes from json to list
                    // This is the list of all of the current user's friends
                    var parsed = JSON.parse(user.friends)
                    for (var j = 0; j < parsed.length; j++){
                      yourFriends.push(parsed[j]);
                    }
                    // Changes from json to list
                    // This is the current user's items list
                    var parsed2 = JSON.parse(user.items)
                    for (var k = 0; k < parsed2.length; k++){
                      trade.push(parsed2[k]);
                    }
                    // Changes from json to list
                    // This is the current user's friend requests list
                    var parsed3 = JSON.parse(user.friendrq)
                    for (var p = 0; p < parsed3.length; p++){
                      friendRequests.push(parsed3[p]);
                    }
                  } 
              }
              // Filling up the tables with the data
              generateTable('yourFriends', yourFriends);
              generateTable('users', users);
              generateTable('trade', trade);
              generateTable('friendRequests', friendRequests);
              return data;
          });
      })
      // catch fetch errors (ie ACCESS to server blocked)
      .catch(err => {
          console.error(err);
      });

  // I used chatgpt to help with this function
  // This helps with table switching when going from column to column
  function showTable(tableId) {
    console.log(tableId);
    // Hide all table containers
    var tables = document.querySelectorAll('.table-container');
    tables.forEach(function(table) {
      table.classList.remove('active');
    });
    
    // Show the selected table container
    var selectedTable = document.getElementById(tableId);
    selectedTable.classList.add('active');
  }

  // Button to send the item
  const sendButton = document.getElementById("sendButton")
  // When clicked then try to send the item
  sendButton.addEventListener("click", function() {
    var receiver = document.getElementById("uid").value
    var thing = document.getElementById("item").value
    // If the receiver is in the friends list, then we can send the item
    if (yourFriends.includes(receiver)) {
        sendItem();
    } 
    // Otherwise there is an alert that tells the user they have to be friends with the receiver
    else {
        alert(`You have to be friends with ${receiver} before sending them an item!`);
    }
  });
</script>

</body>
